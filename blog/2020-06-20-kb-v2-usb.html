<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Custom Keyboard PCB | Armin Emmert</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon.png">
    <link rel="icon" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="description" content="">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <link rel="preload" href="/assets/css/0.styles.2ffeeb0a.css" as="style"><link rel="preload" href="/assets/js/app.38c26cc9.js" as="script"><link rel="preload" href="/assets/js/4.bff238d6.js" as="script"><link rel="preload" href="/assets/js/10.722332ea.js" as="script"><link rel="preload" href="/assets/js/22.a9fa5f24.js" as="script"><link rel="prefetch" href="/assets/js/11.7180a7f4.js"><link rel="prefetch" href="/assets/js/12.25114987.js"><link rel="prefetch" href="/assets/js/13.3e0a2844.js"><link rel="prefetch" href="/assets/js/14.0cf483ae.js"><link rel="prefetch" href="/assets/js/15.b87f657d.js"><link rel="prefetch" href="/assets/js/16.cefb43c7.js"><link rel="prefetch" href="/assets/js/17.646fb3b8.js"><link rel="prefetch" href="/assets/js/18.5095d99d.js"><link rel="prefetch" href="/assets/js/19.8da4a7ac.js"><link rel="prefetch" href="/assets/js/20.04b63a0a.js"><link rel="prefetch" href="/assets/js/21.40a345f7.js"><link rel="prefetch" href="/assets/js/23.a02ebe32.js"><link rel="prefetch" href="/assets/js/24.6190d380.js"><link rel="prefetch" href="/assets/js/25.f7997151.js"><link rel="prefetch" href="/assets/js/26.b2717aa0.js"><link rel="prefetch" href="/assets/js/3.ee061814.js"><link rel="prefetch" href="/assets/js/5.3b390cd4.js"><link rel="prefetch" href="/assets/js/6.4ddd56a0.js"><link rel="prefetch" href="/assets/js/7.051e17b8.js"><link rel="prefetch" href="/assets/js/8.3d762ec6.js"><link rel="prefetch" href="/assets/js/9.da0a3478.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.1c5b5b65.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2ffeeb0a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/vuepress-blog-logo.png" alt="Armin Emmert" class="logo"> <span class="site-name can-hide">Armin Emmert</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/archive/" class="nav-link">Archive</a></div> <a href="https://github.com/emmertarmin/emmertarmin.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <div class="nav-item"><label class="switch"><input type="checkbox" id="darkmode" name="darkmode"> <span class="slider"></span></label></div></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/archive/" class="nav-link">Archive</a></div> <a href="https://github.com/emmertarmin/emmertarmin.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    Repo
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <div class="nav-item"><label class="switch"><input type="checkbox" id="darkmode" name="darkmode"> <span class="slider"></span></label></div></nav>  <!----> </div> <div class="blog" data-v-5ebcfcbc><div class="blog__header" data-v-5ebcfcbc><p class="publish-date" data-v-5ebcfcbc><time datetime="2020-06-20T00:00:00.000Z" data-v-5ebcfcbc>2020-06-20</time></p> <p data-v-5ebcfcbc>Time to read: 8 min read</p> <h1 class="blog__title" data-v-5ebcfcbc>Custom Keyboard PCB</h1></div> <div class="custom content__default" data-v-5ebcfcbc><p></p><div class="table-of-contents"><ul><li><a href="#main-resources">Main Resources</a><ul><li><a href="#qmk-firmware">QMK Firmware</a></li><li><a href="#schematic">Schematic</a></li><li><a href="#routing">Routing</a></li></ul></li><li><a href="#first-prototype">First prototype</a><ul><li><a href="#don-t-use-stm32f103">Don't use STM32F103</a></li><li><a href="#iso-enter-confusion">ISO Enter Confusion</a></li><li><a href="#plugging-it-in">Plugging it in</a></li><li><a href="#conclusion-of-v1">Conclusion of V1</a></li></ul></li><li><a href="#layout-and-features-of-v2">Layout and Features of V2</a><ul><li><a href="#usb-hub">USB hub</a></li><li><a href="#back-side-of-the-pcb">Back side of the PCB</a></li><li><a href="#plate">Plate</a></li></ul></li></ul></div><p></p> <h2 id="main-resources"><a href="#main-resources" class="header-anchor">#</a> Main Resources</h2> <h3 id="qmk-firmware"><a href="#qmk-firmware" class="header-anchor">#</a> QMK Firmware</h3> <p>I was lurking <a href="https://www.reddit.com/r/MechanicalKeyboards">r/mk</a> for half a year probably, and it never occurred to me that I could build my own custom keyboard, until I learned about <a href="https://qmk.fm/">QMK</a>. QMK is an open source firmware for keyboards upheld by the community. It supports a bunch of different hardware, including Atmega, Attiny and some STM microcontrollers. It has an excessive (though not all-encompassing) documentation helping newcomers, and supports backlighting, tap-dance and other awesome features that you won't get with a home-brew Arduino program.</p> <h3 id="schematic"><a href="#schematic" class="header-anchor">#</a> Schematic</h3> <p>There's not incredibly many open source keyboards, but there are a few. Gondolindrim made the highest quality ones, the keyboards in the <a href="http://acheronproject.com/overview.html">Acheron Project</a>. In the QMK Discord he himself recommends newbs to take notice of the <a href="https://github.com/AcheronProject/Tsuki">Tsuki</a>, which has all the features and best practices. I've learnt many things just from studying his schematics. I especially appreciate that his work is full of overengineered solutions, like when he puts a Schottky-diode above the LDO to protect it from backwards current.</p> <h3 id="routing"><a href="#routing" class="header-anchor">#</a> Routing</h3> <p>Here is a <a href="https://wiki.ai03.me/books/pcb-design/page/good-usb-routing-practices">great resource</a> about USB-C routing practices. USB-C in itself is relatively complicated, but by pulling down the CC lines with 5.1k resistors it gets converted to a standard 5 pin USB, which then is easier to handle. I found that the 16-pin connector variant is relatively easy to route and to solder.</p> <p><img src="/img/kb_v2_usb/usb-c.png" alt="USB-C Schematic"></p> <h2 id="first-prototype"><a href="#first-prototype" class="header-anchor">#</a> First prototype</h2> <p>I spent quite some time working on my first PCB, and I knew I wouldn't get everything right. But mostly I hoped to clear up a lot of things I wasn't sure about, and that I could get it to work in some way or another. In some sense I did have a previous prototype already in the form of the &quot;BDN6&quot; <a href="../blog/3d-printer.html">macro board</a>, that I briefly mentioned in my first 3D printer adventures.</p> <h3 id="don-t-use-stm32f103"><a href="#don-t-use-stm32f103" class="header-anchor">#</a> Don't use STM32F103</h3> <p>I went with an STM32F103R8C6 chip because I was somewhat familiar with it, and because it's what <a href="https://stm32-base.org/boards/STM32F103C8T6-Blue-Pill.html">Bluepill</a> uses, which is compatible with QMK. In hindsight it was a bad choice. The F103 doesn't have a USB bootloader from factory, like the F303, F072, and others do. (It also lacks 22Ohm series resistors and the 1.5k pullup on line D+ denoted on page 74 of the <a href="https://www.st.com/resource/en/datasheet/stm32f103r8.pdf">datasheet</a>, as the others do, which is mildly inconvenient.) I did flash some sort of a <a href="https://github.com/rogerclarkmelbourne/STM32duino-bootloader">maple bootloader</a> on it with an ST-Link, but I never really managed to get QMK to work on it. My design included a led on PA13, which confirmed that the bootloader flashed fine. But flashing QMK resulted in this weird &quot;97% completion&quot; error every time, which according to Cannonkeys can be <a href="https://docs.cannonkeys.com/flashing/">safely ignored</a> (?). No matter how much I ignored the message, my computer just wouldn't recognize the keyboard as a HID device.</p> <p><img src="/img/kb_v2_usb/cannonkeys_error.png" alt="Error message"></p> <p>After about two days of this, I placed an order of STM32L072 chips, which do come with a USB bootloader. The L072 has the 22Ohm series resistors and the 1.5k pullup built in, and it is also capable of crystalless USB operation. Of all the SMD components, I hate soldering crystals the most, so I really hope I interpreted that feature right.</p> <h3 id="iso-enter-confusion"><a href="#iso-enter-confusion" class="header-anchor">#</a> ISO Enter Confusion</h3> <p>The ISO Enter key doesn't have good documentation, or at least I didn't find any. I inferred the switch placement under it via the <a href="http://builder.swillkb.com/">swillkb</a> plate builder.</p> <p><img src="/img/kb_v2_usb/iso_enter.svg" alt="ISO Enter switch placement"></p> <p>::: tip ISO Enter switch placement
Vertically, it's in the middle of the 2U height of the Enter key, and horizontally it's in the middle of the narrower, 1.25U wide bottom part of the key.
:::</p> <p>But only when my Tai Hao keycaps arrived, did I learn that the cherry switch underneath has to be upright. Basically, taking a 2U stabilizer together with the switch footprint (e.g. the whole BackSpace key), and rotating it 90 degrees won't work. The stabilizer does have to be rotated to be in a vertical position, but the switch doesn't. The cross profile stem on top of the switch is thicker in one orientation, and thinner in the other, so it only fits the keycap in two of four directions, if that makes sense. To illustrate:</p> <p><img src="/img/kb_v2_usb/iso_enter_footprint.png" alt="ISO Enter switch placement"></p> <h3 id="plugging-it-in"><a href="#plugging-it-in" class="header-anchor">#</a> Plugging it in</h3> <p>Obviously, I didn't just plug the board into the computer without much thought. I actually broke out GND, +3V3, and +5V, so that I could easily test for short circuits. And when I was confident, I first connected it to 5V from a power supply to check for magic smoke. Then I measured the aforementioned voltages, and actually discovered a diode that was soldered on backwards, which was apparent, because the voltages didn't match. Only when everything checked out, did I connect it to my laptop.</p> <h3 id="conclusion-of-v1"><a href="#conclusion-of-v1" class="header-anchor">#</a> Conclusion of V1</h3> <p>V1 uncovered three times as many oversights and bugs as I had anticipated. Even though this sounds bad, I have gotten much more confident in what I'm doing, and I can definitely see the light at the end of the tunnel.</p> <h2 id="layout-and-features-of-v2"><a href="#layout-and-features-of-v2" class="header-anchor">#</a> Layout and Features of V2</h2> <p>After everything I've learnt, I corrected the schematic and rerouted the whole board. There's even some extra features that I included along the way, which I am going to discuss here. I have great hopes for V2, and I haven't ordered it yet, but I'm happy enough with it that I want to share it beforehand.</p> <p><img src="/img/kb_v2_usb/top.svg" alt="PCB top"></p> <p>The image above of the top of the PCB was created with <a href="https://tracespace.io">tracespace.io</a>, which is open source, and generates awesome looking svg images. You just need to upload the same gerber files that you would send to the PCB manufacturer.</p> <p>I decided to branch off of &quot;the 75%&quot; layout, which means it is tenkeyless, has the whole function row, and has the arrows compressed under &quot;Enter&quot;. The top right corner supports a regular switch or an encoder. You can inspect it on <a href="http://www.keyboard-layout-editor.com/##@_name=75%25%3B&amp;@=Esc&amp;=F1&amp;=F2&amp;=F3&amp;=F4&amp;=F5&amp;=F6&amp;=F7&amp;=F8&amp;=F9&amp;=F10&amp;=F11&amp;=F12&amp;=PgUp&amp;=PgDn&amp;=ENC%3B&amp;@=~`&amp;=!1&amp;=%2F@2&amp;=%233&amp;=$4&amp;=%255&amp;=^6&amp;=%2F&amp;7&amp;=*8&amp;=(9&amp;=)0&amp;=%2F_-&amp;=+%2F=&amp;_w:2%3B&amp;=Backspace&amp;=Delete%3B&amp;@_w:1.5%3B&amp;=Tab&amp;=Q&amp;=W&amp;=E&amp;=R&amp;=T&amp;=Y&amp;=U&amp;=I&amp;=O&amp;=P&amp;={[&amp;=}]&amp;_x:0.25&amp;w:1.25&amp;h:2&amp;w2:1.5&amp;h2:1&amp;x2:-0.25%3B&amp;=Enter&amp;_a:7%3B&amp;=%3B&amp;@_a:4&amp;w:1.75%3B&amp;=Caps Lock&amp;=A&amp;=S&amp;=D&amp;=F&amp;=G&amp;=H&amp;=J&amp;=K&amp;=L&amp;=%2F:%2F%3B&amp;=%22'&amp;=|\&amp;_x:1.25%3B&amp;=Home%3B&amp;@_w:1.25%3B&amp;=Shift&amp;=|\&amp;=Z&amp;=X&amp;=C&amp;=V&amp;=B&amp;=N&amp;=M&amp;=&lt;,&amp;=&gt;.&amp;=%3F%2F%2F&amp;_w:1.75%3B&amp;=Shift&amp;=↑&amp;=End%3B&amp;@_w:1.25%3B&amp;=Ctrl&amp;_w:1.25%3B&amp;=Win&amp;_w:1.25%3B&amp;=Alt&amp;_a:7&amp;w:6.25%3B&amp;=&amp;_a:4%3B&amp;=Alt&amp;=Menu&amp;=Ctrl&amp;=←&amp;=↓&amp;=→">Keyboard Layout Editor</a>.</p> <p>I wanted the whole PCB to fit entirely under the keycaps, partly to be slick, and partly because I embraced the challenge. The only exception is the USB-C connector, which sticks out on top. In contrast to that, I cut out enough place under the spacebar for a whole USB-A connector, where the receiver of my wireless mouse should fit. If it works as I planned, I'll be really proud of that! Although I'll admit that if I didn't have this bezel-constraint, I'd prefer to have the receiver on the right side for line of sight.</p> <h3 id="usb-hub"><a href="#usb-hub" class="header-anchor">#</a> USB hub</h3> <p>Designing a keyboard takes a huge amount of time and money, and the schematic of mine was strongly based on the open source Tsuki from the Acheron Project. For these reasons I wanted to have an extra quork that few others have done, but which is functional and practical for my own use case. And this is it!</p> <p>Others have integrated USB hubs, but as far as I can tell, it hasn't become mainstream in the custom keyboard community. USB is more complicated than just combining data lines. No wonder that there's so many controller ICs to choose from. I went with the USB2514, partly because it's said to be a better modern one, and partly because I had access to it at Hestore, which is my favorite &quot;local&quot; electronics shop in Budapest. The only problem I have with it is the packaging, which is the hardest-to-solder part on my keyboard now. If I'll have issues with it, I think I will fall back to the FE1.1, because it generally seems easier to use, and it also requires less components around it. Actually, I'm reevaluating my choices as I'm writing this.</p> <p>Since I only plan to use one USB downline on the STM chip, and the other on the wireless mouse receiver, I didn't bother setting up proper power management. My other reason for doing so is cost-effectiveness, and physical space. There's two passive components already, that I pushed on the other side of the PCB, despite my wanting to showcase everything on the bottom side. This compromise still bugs me when I think of it, but I don't think I could have fit power management components. Maybe if I remove the function row, but leave the space as a top-bezel, then I'd have room for these features, and stay in the form-factor of the <a href="https://github.com/coseyfannitutti/discipline">Discipline</a>.</p> <h3 id="back-side-of-the-pcb"><a href="#back-side-of-the-pcb" class="header-anchor">#</a> Back side of the PCB</h3> <p><img src="/img/kb_v2_usb/bottom.svg" alt="PCB bottom"></p> <p>The plan is to have (almost) all of the components on the back side, along with some design features, and to show it all off through an acrylic bottom plate. The huge fish logo is an homage to my hometown in Hungary, Baja, which is famous for the annual fish soup festival. The placement is lucky, as it doesn't cover any important silkscreen markings.</p> <p>Hofstädter's law says that everything takes longer, than expected, even if one takes into account this law. It's a funny line that will resonate with most engineers. It certainly resonates with me, so I put that on there too.</p> <h3 id="plate"><a href="#plate" class="header-anchor">#</a> Plate</h3> <p><img src="/img/kb_v2_usb/plate_top.svg" alt="Plate"></p> <p>A USB-A connector is too high to fit between the PCB and the plate, so it had to be cut out from the plate. To make it sturdy, I had to disable the horizontal cutout under the space key. I'm curious to see what disadvantages I introduced there.</p></div> <div class="page-edit" data-v-5ebcfcbc><!----> <!----></div> <!----> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.38c26cc9.js" defer></script><script src="/assets/js/4.bff238d6.js" defer></script><script src="/assets/js/10.722332ea.js" defer></script><script src="/assets/js/22.a9fa5f24.js" defer></script>
  </body>
</html>
